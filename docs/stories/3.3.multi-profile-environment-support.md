# Story 3.3: Multi-Profile Environment Support

**Epic**: Epic 3 - Configuration & Secret Management

---

## Status

**Current Status**: Ready for Development

**Status Updated**: 2025-11-11 - Story created and ready for development team assignment.

---

## Story

**As a** developer,
**I want** to quickly switch between different environment profiles (minimal, full, etc.),
**so that** I can optimize my setup for different types of work.

---

## Acceptance Criteria

1. Support for multiple profile configurations (e.g., `.env.minimal`, `.env.full`)
2. `make dev profile=minimal` starts only essential services (backend + database)
3. `make dev profile=full` starts all services including frontend, Redis, and any optional services
4. Default profile (no argument) starts the full stack
5. Documentation explains each profile and when to use it
6. Profile selection is validated; invalid profiles show error with list of available profiles

---

## Tasks / Subtasks

- [ ] Design profile configuration system (AC: 1, 2, 3)
  - [ ] Define available profiles: `minimal`, `full`, and any others (standard, development)
  - [ ] Document which services are included in each profile
  - [ ] Define profile-specific environment variable overrides
  - [ ] Design profile selection mechanism (command-line argument)
  - [ ] Document profile hierarchy and defaults
  - [ ] Create profile configuration data structure

- [ ] Create profile-specific `.env` files (AC: 1)
  - [ ] Create `.env.minimal` with minimal configuration
    - [ ] Include only essential variables for backend and database
    - [ ] Disable frontend service startup
    - [ ] Disable Redis service startup
    - [ ] Include performance-optimized settings
    - [ ] Document use case: backend-only development
  - [ ] Create `.env.full` with complete configuration
    - [ ] Include all service variables
    - [ ] Enable all services (frontend, backend, database, Redis)
    - [ ] Include full feature set
    - [ ] Document use case: full-stack development
  - [ ] Create `.env.development` (optional) with development defaults
  - [ ] Create `.env.example` updates to reference profile files
  - [ ] Add comments in each profile explaining its purpose and use case

- [ ] Update Makefile for profile support (AC: 2, 3, 4, 6)
  - [ ] Modify `make dev` to accept optional `profile` argument
    - [ ] Syntax: `make dev profile=minimal` or `make dev profile=full`
    - [ ] Default to `full` profile when no profile specified
    - [ ] Support multiple ways to specify profile (argument, env var, config)
  - [ ] Implement profile validation before loading
  - [ ] Create `make profiles` command to list available profiles
  - [ ] Create profile selection logic in startup script
  - [ ] Update help text with profile documentation
  - [ ] Test profile argument parsing with various inputs

- [ ] Create profile validation function (AC: 6)
  - [ ] Implement profile validation script in `/infrastructure/scripts/validate-profile.sh`
    - [ ] Check if specified profile exists as `.env.{profile}` file
    - [ ] Return list of available profiles if invalid
    - [ ] Validate profile file has required variables
    - [ ] Check for conflicting service configurations
    - [ ] Ensure database is always included in any profile
  - [ ] Create validation function in TypeScript/JavaScript
  - [ ] Provide helpful error message with available options
  - [ ] Example error: "Invalid profile: 'custom'. Available profiles: minimal, full"

- [ ] Update Docker Compose profile support (AC: 2, 3, 4)
  - [ ] Add Docker Compose service profiles (groups) for optional services
    - [ ] Create profile group for frontend service
    - [ ] Create profile group for Redis service
    - [ ] Create profile group for optional monitoring services
  - [ ] Update Docker Compose startup to only include services for selected profile
  - [ ] Ensure database and backend are always included
  - [ ] Test Docker Compose with different profile configurations
  - [ ] Verify services start/stop based on profile selection
  - [ ] Document Docker Compose profile mechanism

- [ ] Create startup script for profile support (AC: 2, 3, 4)
  - [ ] Update `/infrastructure/scripts/startup.sh` to accept profile parameter
  - [ ] Implement profile loading mechanism
    - [ ] Load base `.env.example`
    - [ ] Load profile-specific `.env.{profile}` file
    - [ ] Merge configurations with profile overrides
  - [ ] Implement service orchestration based on profile
    - [ ] Minimal profile: Start only database and backend services
    - [ ] Full profile: Start all services (database, backend, frontend, Redis)
  - [ ] Add profile information to startup output
  - [ ] Display which profile is being used
  - [ ] Show which services will start for selected profile
  - [ ] Exit gracefully if profile validation fails

- [ ] Update health check for profiles (AC: 2, 3, 4)
  - [ ] Modify health check script to only check services in active profile
  - [ ] Minimal profile: Check only backend and database health
  - [ ] Full profile: Check all services (backend, database, frontend, Redis)
  - [ ] Handle optional services that may not be running
  - [ ] Provide profile-aware health status output
  - [ ] Include service availability status in health checks

- [ ] Update `make down` for profiles (AC: 2, 3, 4)
  - [ ] Ensure `make down` stops all services regardless of profile
  - [ ] Preserve data volumes after teardown
  - [ ] Clean up containers for all services
  - [ ] Handle partial service cleanup gracefully

- [ ] Create profile documentation (AC: 5)
  - [ ] Create `/docs/PROFILES.md` comprehensive guide
    - [ ] Document each available profile with:
      - [ ] Profile name and purpose
      - [ ] Services included in profile
      - [ ] Use cases and when to use
      - [ ] Performance characteristics
      - [ ] Resource requirements
      - [ ] Configuration differences from other profiles
    - [ ] Minimal profile documentation
      - [ ] Purpose: Fast backend-only development
      - [ ] Services: PostgreSQL + Backend API
      - [ ] Use case: API development without UI, debugging, testing services independently
      - [ ] Benefits: Faster startup, lower resource usage
      - [ ] Tradeoffs: Cannot test full-stack integration
    - [ ] Full profile documentation
      - [ ] Purpose: Complete development environment
      - [ ] Services: PostgreSQL + Backend API + Frontend + Redis
      - [ ] Use case: Full-stack feature development, end-to-end testing, integration verification
      - [ ] Benefits: Complete application environment, realistic testing
      - [ ] Tradeoffs: Slower startup, higher resource usage
    - [ ] Profile comparison table
    - [ ] Performance benchmarks for each profile
  - [ ] Update README with profiles section
    - [ ] Quick reference for common profiles
    - [ ] Example: `make dev profile=minimal`
    - [ ] Link to detailed PROFILES.md documentation
    - [ ] Explain when to use each profile
  - [ ] Update `/docs/CONFIGURATION.md` with profile information
    - [ ] Explain how profiles interact with environment variables
    - [ ] Document profile loading order
    - [ ] Document profile override behavior
    - [ ] Include profile examples and use cases

- [ ] Add profile examples to documentation (AC: 5)
  - [ ] Create `/docs/examples/profiles-minimal.md` with minimal setup guide
  - [ ] Create `/docs/examples/profiles-custom.md` with custom profile creation
  - [ ] Document how to create custom profiles beyond minimal/full
  - [ ] Include examples of service combinations
  - [ ] Document profile variable inheritance and overrides

- [ ] Implement profile support in `make config` (AC: 2, 3, 4, 6)
  - [ ] Update `make config` command to show profile-aware configuration
  - [ ] Support profile validation: `make config profile=minimal`
  - [ ] Display loaded configuration for selected profile
  - [ ] Show which services are enabled/disabled for profile
  - [ ] Highlight profile-specific settings
  - [ ] Validate profile can be loaded successfully

- [ ] Update backend service for profile awareness (AC: 2, 3)
  - [ ] Add configuration flag to indicate active profile
  - [ ] Load profile name from environment or config
  - [ ] Log active profile on startup
  - [ ] Include profile information in application metadata
  - [ ] Optional: Adjust backend behavior based on profile (e.g., skip frontend checks in minimal profile)

- [ ] Update frontend service for profile awareness (AC: 2, 3)
  - [ ] Frontend should handle gracefully if loaded with minimal profile
  - [ ] Add configuration to indicate current environment
  - [ ] Skip unnecessary initialization if running in minimal profile
  - [ ] Frontend startup script should only execute if included in profile

- [ ] Create profile selection tests (AC: 2, 3, 4, 6)
  - [ ] Create `/infrastructure/__tests__/profile-selection.test.sh`
    - [ ] Test default profile (no argument) uses full stack
    - [ ] Test `make dev profile=minimal` starts correct services
    - [ ] Test `make dev profile=full` starts all services
    - [ ] Test invalid profile shows error with available options
    - [ ] Test `make config profile=minimal` validates correctly
    - [ ] Test `make config profile=invalid` shows available profiles
    - [ ] Test profile environment variables are loaded correctly
    - [ ] Test profile-specific services are started/stopped
  - [ ] Create shell script tests for profile loading
  - [ ] Test profile merging and variable override behavior

- [ ] Create service startup integration tests (AC: 2, 3, 4)
  - [ ] Test minimal profile: Verify only backend and database start
    - [ ] Check backend service is running
    - [ ] Check database service is running
    - [ ] Check frontend service is NOT running
    - [ ] Check Redis service is NOT running
    - [ ] Verify backend can connect to database
    - [ ] Verify health checks pass for running services
  - [ ] Test full profile: Verify all services start
    - [ ] Check all four services are running
    - [ ] Verify inter-service communication
    - [ ] Verify all health checks pass
  - [ ] Test profile switching: Clean state between profiles
    - [ ] Stop services from previous profile
    - [ ] Start services for new profile
    - [ ] Clean up containers from previous profile

- [ ] Create documentation for custom profiles (AC: 5)
  - [ ] Document how developers can create custom profiles
  - [ ] Explain profile file naming convention: `.env.{profile-name}`
  - [ ] Document required and optional variables for custom profiles
  - [ ] Explain how to extend profiles (inheritance)
  - [ ] Include example: Creating a "api-only" profile
  - [ ] Explain profile-specific service configuration

- [ ] Update Makefile help and documentation (AC: 5, 6)
  - [ ] Update `make help` to document profile support
  - [ ] Include examples of profile usage
  - [ ] Document available profiles
  - [ ] Add profile switching examples
  - [ ] Link to PROFILES.md documentation
  - [ ] Update Makefile comments with profile explanation

- [ ] Implement environment variable merging (AC: 2, 3, 4)
  - [ ] Load base environment from `.env.example`
  - [ ] Load user environment from `.env` (if exists)
  - [ ] Load profile-specific environment from `.env.{profile}`
  - [ ] Merge configurations with proper precedence:
    - [ ] `.env.example` (lowest priority - defaults)
    - [ ] `.env.{profile}` (profile-specific overrides)
    - [ ] `.env` (highest priority - user customization)
  - [ ] Handle missing or empty profile gracefully
  - [ ] Document merge behavior and precedence

- [ ] Create profile switching automation (AC: 2, 3, 4)
  - [ ] Implement `make profile=<name>` as shorthand for `make dev profile=<name>`
  - [ ] Optional: Create `make switch-profile <name>` command
  - [ ] Add ability to list current active profile
  - [ ] Document profile switching syntax and behavior

- [ ] Validate all acceptance criteria are met (AC: 1-6)
  - [ ] Verify multiple profile configurations exist (minimal, full)
  - [ ] Manual test: `make dev profile=minimal` starts only backend + database
  - [ ] Manual test: `make dev profile=full` starts all services
  - [ ] Manual test: `make dev` (no argument) defaults to full stack
  - [ ] Manual test: Invalid profile shows error with available profiles
  - [ ] Manual test: Documentation clearly explains each profile
  - [ ] Verify profile validation works correctly
  - [ ] Verify all services required by profile start successfully
  - [ ] Verify services not in profile do not start
  - [ ] Run all profile selection tests
  - [ ] Run all service startup integration tests
  - [ ] Run acceptance criteria checklist

---

## Dev Notes

### Project Context

This is Story 3.3 in Epic 3: Configuration & Secret Management. This story builds on Story 3.1 (Environment Variable Configuration System) to provide developers with flexibility to run different service configurations based on their current work needs.

The goal is to support different development workflows:
- **Minimal Profile**: For developers working purely on backend/API, who need fast startup and minimal resource usage
- **Full Profile**: For full-stack development, integration testing, and end-to-end validation

This story enables developers to optimize their local environment for their current task without affecting other developers' setups.

### Current Implementation Status

**From Story 3.1 (Foundation)**:
- Environment variable configuration system in place
- `.env.example` exists with all configuration variables
- Backend and frontend load configuration from environment
- Configuration validation implemented
- `.env` is properly git-ignored

**From Story 3.2 (Secrets)**:
- Mock secret management patterns documented
- Secret validation in place

**Current Multi-Profile Issues**:
- No profile support in current setup
- All services always start with `make dev`
- No way to optimize for API-only development
- No documentation on different development workflows

**What Needs to be Built for This Story**:
- Profile configuration files (`.env.minimal`, `.env.full`)
- Profile selection mechanism in Makefile
- Docker Compose profile configuration
- Profile validation and error handling
- Comprehensive profile documentation
- Tests for profile selection and service startup
- Startup script modifications for profile support
- Health check updates for profile-aware checking

### Technical Architecture

**Profile Configuration Structure:**

```
Available Profiles:
  minimal   - Backend API + Database only
  full      - All services (Frontend + Backend + Database + Redis)
```

**Profile Loading Flow:**

```
User runs: make dev profile=minimal
    ↓
Validate profile exists
    ↓
Load base configuration from .env.example
    ↓
Load profile-specific .env.minimal
    ↓
Load user .env (if exists) - highest priority
    ↓
Merge configurations (precedence: example < profile < user)
    ↓
Pass to Docker Compose with profile filters
    ↓
Start only services matching profile
    ↓
Run health checks for profile services
```

**Service Inclusion by Profile:**

```
Minimal Profile:
  - PostgreSQL (database)
  - Node.js Backend API
  - (no Redis, no Frontend)

Full Profile:
  - PostgreSQL (database)
  - Node.js Backend API
  - React Frontend
  - Redis Cache
```

**Docker Compose Profile Structure:**

```yaml
services:
  postgres:
    # Always included - no profile

  backend:
    # Always included - no profile

  redis:
    profiles:
      - full  # Only included in full profile

  frontend:
    profiles:
      - full  # Only included in full profile
```

### File Locations & Naming Conventions

**Configuration Files**:
- `/.env.minimal` - Minimal profile configuration
- `/.env.full` - Full profile configuration
- `/.env.example` - Base configuration (reference)
- `/.env` - User local configuration (git-ignored)

**Script Files**:
- `/infrastructure/scripts/startup.sh` - Updated for profile support
- `/infrastructure/scripts/validate-profile.sh` - Profile validation
- `/infrastructure/scripts/load-profile.sh` - Profile loading logic

**Test Files**:
- `/infrastructure/__tests__/profile-selection.test.sh` - Profile selection tests
- `/infrastructure/__tests__/profile-integration.test.sh` - Service startup tests

**Documentation Files**:
- `/docs/PROFILES.md` - Comprehensive profile guide
- `/docs/examples/profiles-minimal.md` - Minimal profile guide
- `/docs/examples/profiles-custom.md` - Custom profile creation guide
- `/README.md` - Updated with profiles section

### Implementation Approach

**Phase 1: Profile Files & Documentation**

1. Create `.env.minimal` with minimal configuration
2. Create `.env.full` with full configuration
3. Document each profile in PROFILES.md
4. Update README with profile information

**Phase 2: Profile Selection & Validation**

1. Create profile validation script
2. Implement profile validation in startup process
3. Add error handling for invalid profiles
4. Create `make profiles` command to list available

**Phase 3: Docker Compose Integration**

1. Add service profiles to docker-compose.yml
2. Update service definitions with profile groups
3. Test profile filtering with Docker Compose
4. Verify correct services start for each profile

**Phase 4: Makefile & Startup Integration**

1. Update Makefile to accept profile argument
2. Modify startup.sh for profile loading
3. Implement environment variable merging
4. Update health check for profile-aware checking
5. Test `make dev profile=minimal` and `make dev profile=full`

**Phase 5: Configuration Integration**

1. Update backend for profile awareness
2. Update frontend for profile awareness
3. Add profile information to startup output
4. Test profile configuration merging

**Phase 6: Testing & Documentation**

1. Create profile selection tests
2. Create service startup integration tests
3. Test all acceptance criteria
4. Document test results

### Dependencies & Integration Points

**Dependencies On:**
- Story 3.1: Environment Variable Configuration System
- Story 3.2: Mock Secret Management Pattern
- Docker Compose: Service profiles feature (v1.29+)

**Integration Points:**
- **Makefile**: Accept profile argument, default to full
- **Docker Compose**: Use service profiles for conditional service startup
- **Startup Script**: Load and validate selected profile
- **Configuration System**: Merge profile and user configurations
- **Health Checks**: Validate health of services in active profile
- **Documentation**: PROFILES.md and profile examples

### Known Constraints & Notes

1. **Docker Compose Version**: Service profiles require Docker Compose v1.29 or later
   - Must document minimum Docker Compose version requirement
   - Provide fallback approach if older version detected

2. **Profile Precedence**: Configuration override order must be clear
   - Base defaults < profile-specific < user customization
   - Document merge behavior clearly

3. **Service Dependencies**: Database must be included in all profiles
   - Backend depends on database
   - Even minimal profile needs database
   - Frontend optionally depends on Redis and Backend

4. **Service Health**: Health check behavior changes by profile
   - Minimal: Only check backend and database
   - Full: Check all four services
   - Must handle missing services gracefully

5. **Platform Compatibility**: Profile support must work cross-platform
   - macOS, Linux, Windows (WSL2)
   - Path handling in profile files
   - Command syntax compatibility

### Testing Requirements

**Test Scenarios**:
1. Default behavior: `make dev` starts full stack
2. Profile specification: `make dev profile=minimal`
3. Profile validation: Invalid profile shows error
4. Service startup: Correct services run for each profile
5. Health checks: Only check services in active profile
6. Configuration merging: Profile and user configs merge correctly
7. `make config` with profiles: Validate profile-specific config
8. Service communication: Inter-service communication works in profile
9. Teardown: `make down` stops all services regardless of profile
10. Profile switching: Can switch between profiles without cleanup issues

**Test Environment**:
- Docker Compose with profile support (v1.29+)
- Multiple profile configurations
- Service startup/health check verification
- Manual testing with different profiles

### Success Criteria

Story is complete when:
- `.env.minimal` and `.env.full` profile files exist with appropriate configurations
- `make dev profile=minimal` starts only backend and database
- `make dev profile=full` starts all services (frontend, backend, database, Redis)
- `make dev` (no argument) defaults to full stack
- Invalid profile shows clear error with available profiles
- Profile documentation in PROFILES.md explains each profile and use cases
- Profile validation catches invalid profiles with helpful messages
- All services for selected profile start and pass health checks
- Configuration merging works correctly for profiles
- Tests pass for profile selection and service startup
- All acceptance criteria are validated

---

## Dev Agent Notes

_This section will be populated when development begins._

### Agent Model Assignment

_To be assigned during sprint planning._

### Completion Notes

_To be populated when story is complete._

### File List

**To be created during development:**
- `/.env.minimal`
- `/.env.full`
- `/infrastructure/scripts/validate-profile.sh`
- `/infrastructure/scripts/load-profile.sh`
- `/infrastructure/__tests__/profile-selection.test.sh`
- `/infrastructure/__tests__/profile-integration.test.sh`
- `/docs/PROFILES.md`
- `/docs/examples/profiles-minimal.md`
- `/docs/examples/profiles-custom.md`

**To be modified during development:**
- `/Makefile`
- `/infrastructure/scripts/startup.sh`
- `/infrastructure/scripts/health-check.sh`
- `/docker-compose.yml`
- `/backend/src/config/env.ts`
- `/frontend/src/config/env.ts`
- `/README.md`
- `/docs/CONFIGURATION.md`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-11 | 1.0 | Initial story creation from PRD | Scrum Master (Bob) |

---

## QA Results

_QA results will be populated after story development and testing completion._

---

## Next Steps After Development

**After Story 3.3 is complete:**

1. **Story 3.4: Port Conflict Detection & Resolution** can begin, as it may need profile-aware port checking
2. **Story 3.5: Database Seeding & Test Data Management** can begin, as seeding behavior may differ by profile
3. Consider extending profiles for specialized workflows:
   - Testing-only profile
   - Performance-testing profile
   - Monitoring-only profile

**Quality Assurance Checklist:**
- [ ] Verify `make dev profile=minimal` starts only required services
- [ ] Verify `make dev profile=full` starts all services
- [ ] Verify `make dev` defaults to full stack
- [ ] Test invalid profile error message and available profiles list
- [ ] Verify health checks work correctly for each profile
- [ ] Test configuration merging from multiple sources
- [ ] Verify documentation is clear about profile usage
- [ ] Test profile switching without cleanup issues
- [ ] Verify services in profile communicate correctly

**Developer Handoff Checklist:**
- [ ] Review PROFILES.md documentation for clarity
- [ ] Test profile selection with various commands
- [ ] Verify `make help` explains profile syntax
- [ ] Test that profile configuration overrides work as expected
- [ ] Verify profile-specific services start and stop correctly

---
